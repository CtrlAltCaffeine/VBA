# ---------------- CHANGED BLOCK START ----------------
portfolio_list = portfolio_data if isinstance(portfolio_data, list) else [portfolio_data]

def collect_attr(e, attr):
    vals = []
    if isinstance(e, dict):
        v = e.get(attr)
        if isinstance(v, list):
            for item in v:
                if isinstance(item, dict):
                    for subv in item.values():
                        if subv is not None and not isinstance(subv, dict):
                            vals.append(str(subv))
                else:
                    vals.append(str(item))
        elif v is not None:
            vals.append(str(v))
    elif isinstance(e, list):
        for elt in e:
            if isinstance(elt, dict):
                vv = elt.get(attr)
                if isinstance(vv, list):
                    for it in vv:
                        if isinstance(it, dict):
                            continue
                        vals.append(str(it))
                elif vv is not None:
                    vals.append(str(vv))
            elif isinstance(elt, list):
                for sub in elt:
                    if isinstance(sub, dict):
                        sv = sub.get(attr)
                        if sv is None:
                            continue
                        if isinstance(sv, list):
                            for it in sv:
                                vals.append(str(it))
                        else:
                            vals.append(str(sv))
                    else:
                        vals.append(str(sub))
            else:
                vals.append(str(elt))
    else:
        if e is not None:
            vals.append(str(e))
    return ','.join(vals) if vals else None

for p in portfolio_list:
    entities = p.get('entities', {}) if isinstance(p, dict) else {}
    common_metadata = {
        'report_status': report_data.get('@status'),
        'portfolio_id': p.get('@id') if isinstance(p, dict) else None,
        'cycle_date': (p.get('cycle') or {}).get('@date') if isinstance(p, dict) else None,
        'cycle_code': (p.get('cycle') or {}).get('@code') if isinstance(p, dict) else None,
        'clrMbrFirmId': collect_attr(entities, '@clrMbrFirmId'),
        'pbAcctId': collect_attr(entities, '@pbAcctId')
    }
    transactions = (p.get('transactions') or {}).get('transaction') if isinstance(p, dict) else None
    if transactions is None:
        continue
    if isinstance(transactions, dict):
        transactions = [transactions]
    for transaction in transactions:
        xml_payload_string = transaction.get('payload', {}).get('string') if isinstance(transaction, dict) else None
        if not xml_payload_string:
            continue
        record = parse_xml_record(xml_payload_string)
        if record:
            full_record = {**common_metadata, **record}
            parsed_records.append(full_record)
# ---------------- CHANGED BLOCK END ----------------

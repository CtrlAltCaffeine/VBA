import xml.etree.ElementTree as ET
import csv

def parse_xml_to_csv(xml_file, csv_file):
    tree = ET.parse(xml_file)
    root = tree.getroot()

    def get_text_or_default(element, default=''):
        return element.text if element is not None else default

    with open(csv_file, 'w', newline='') as csvfile:
        writer = csv.writer(csvfile)

        headers = ['firm', 'acctId', 'acctType', 'isCust', 'currency', 'ec', 
                   'exch', 'pfCode', 'pfType', 'pe', 'undPe', 'o', 'k', 'net']
        writer.writerow(headers)

        for portfolio in root.findall('.//portfolio'):
            firm = get_text_or_default(portfolio.find('firm'))
            acctId = get_text_or_default(portfolio.find('acctId'))
            acctType = get_text_or_default(portfolio.find('acctType'))
            isCust = get_text_or_default(portfolio.find('isCust'))
            currency = get_text_or_default(portfolio.find('currency'))
            ec = get_text_or_default(portfolio.find('.//ecPort/ec'))

            for np in portfolio.findall('.//np'):
                exch = get_text_or_default(np.find('exch'))
                pfCode = get_text_or_default(np.find('pfCode'))
                pfType = get_text_or_default(np.find('pfType'))
                pe = get_text_or_default(np.find('pe'))
                undPe = get_text_or_default(np.find('undPe'))
                o = get_text_or_default(np.find('o'))
                k = get_text_or_default(np.find('k'))
                net = get_text_or_default(np.find('net'))

                writer.writerow([firm, acctId, acctType, isCust, currency, ec, 
                                 exch, pfCode, pfType, pe, undPe, o, k, net])

    print(f"Data successfully written to {csv_file}")

xml_file = 'path_to_your_xml_file.xml'
csv_file = 'output_data.csv'
parse_xml_to_csv(xml_file, csv_file)

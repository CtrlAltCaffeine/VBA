function onOpen() {
  var ui = SpreadsheetApp.getUi();
  ui.createMenu('Custom Scripts')
    .addItem('Create Table and Chart', 'createTableAndChart')
    .addToUi();
}

function createTableAndChart() {
  var sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  var dataRange = sheet.getDataRange();
  var data = dataRange.getValues();
  
  // Create HTML output
  var htmlOutput = HtmlService.createHtmlOutput();
  htmlOutput.append('<h1>Survey Data Analysis</h1>');

  // Create table
  htmlOutput.append('<h2>Firm Comments</h2>');
  htmlOutput.append('<table border="1" cellpadding="5"><tr><th>Firm ID/Name</th><th>Comments</th></tr>');
  for (var i = 1; i < data.length; i++) {
    htmlOutput.append('<tr><td>' + data[i][1] + '</td><td>' + data[i][6] + '</td></tr>');
  }
  htmlOutput.append('</table>');

  // Add chart div
  htmlOutput.append('<div id="stackedBarChart"></div>');
  htmlOutput.append('<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>');
  htmlOutput.append('<script type="text/javascript">');
  htmlOutput.append('google.charts.load("current", {packages:["corechart"]});');
  htmlOutput.append('google.charts.setOnLoadCallback(drawStackedBarChart);');

  // Add the script to draw the chart
  htmlOutput.append('function drawStackedBarChart() {');
  htmlOutput.append('var data = google.visualization.arrayToDataTable([');
  htmlOutput.append('["Date", "First Preference", "Second Preference", "Third Preference"],');

  // Process data for chart
  var chartData = {};
  for (var i = 1; i < data.length; i++) {
    var firstDate = data[i][2];
    var secondDate = data[i][3];
    var thirdDate = data[i][4];
    if (!chartData[firstDate]) chartData[firstDate] = [0, 0, 0];
    if (!chartData[secondDate]) chartData[secondDate] = [0, 0, 0];
    if (!chartData[thirdDate]) chartData[thirdDate] = [0, 0, 0];
    chartData[firstDate][0]++;
    chartData[secondDate][1]++;
    chartData[thirdDate][2]++;
  }

  // Append chart data to script
  for (var date in chartData) {
    htmlOutput.append('["' + date + '", ' + chartData[date][0] + ', ' + chartData[date][1] + ', ' + chartData[date][2] + '],');
  }

  htmlOutput.append(']);');

  // Chart options
  htmlOutput.append('var options = {');
  htmlOutput.append('isStacked: true,');
  htmlOutput.append('title: "Preference Dates Distribution",');
  htmlOutput.append('hAxis: {title: "Dates"},');
  htmlOutput.append('vAxis: {title: "Count"}');
  htmlOutput.append('};');

  htmlOutput.append('var chart = new google.visualization.ColumnChart(document.getElementById("stackedBarChart"));');
  htmlOutput.append('chart.draw(data, options);');
  htmlOutput.append('}');
  htmlOutput.append('</script>');

  // Show the output
  var html = htmlOutput.getContent();
  var htmlOutputDialog = HtmlService.createHtmlOutput(html)
    .setWidth(800)
    .setHeight(600);
  SpreadsheetApp.getUi().showModalDialog(htmlOutputDialog, 'Survey Data Analysis');
}


/**
 * @OnlyCurrentDoc
 */

function getLabelSubjectsToSheet() {
  // --- USER CONFIGURATION ---
  const labelNameToSearch = "MyImportantLabel"; // <<< REPLACE THIS with your exact Gmail label name!

  // --- SCRIPT LOGIC ---
  const subjects = [];
  const label = GmailApp.getUserLabelByName(labelNameToSearch);

  if (!label) {
    Logger.log(`Error: Label "${labelNameToSearch}" not found.`);
    SpreadsheetApp.getUi().alert('Error', `Gmail label "${labelNameToSearch}" not found. Please check the name and try again.`, SpreadsheetApp.getUi().ButtonSet.OK);
    return;
  }

  let start = 0;
  const maxThreadsPerCall = 500; // Gmail API limit per call

  Logger.log(`Starting to fetch subjects from label: "${labelNameToSearch}"`);

  // Loop to get all threads (handles more than 500 threads)
  while (true) {
    const threads = label.getThreads(start, maxThreadsPerCall);
    if (threads.length === 0) {
      break; // No more threads
    }

    for (let i = 0; i < threads.length; i++) {
      const messages = threads[i].getMessages();
      for (let j = 0; j < messages.length; j++) {
        subjects.push([messages[j].getSubject()]); // Push as a 2D array for setValues
      }
    }
    start += threads.length;
    // Utilities.sleep(50); // Optional: small delay for very large labels
  }

  Logger.log(`Found ${subjects.length} subjects.`);

  // Create or get the active spreadsheet
  let ss = SpreadsheetApp.getActiveSpreadsheet();
  if (!ss) {
    ss = SpreadsheetApp.create(`Email Subjects - ${labelNameToSearch}`); // Creates a new sheet if run standalone
    Logger.log(`Created new spreadsheet: ${ss.getUrl()}`);
  }

  // Create a new sheet (tab) for the results
  const newSheetName = `Subjects from ${labelNameToSearch} (${new Date().toLocaleDateString()})`;
  let sheet = ss.getSheetByName(newSheetName);
  if (sheet) {
    sheet.clearContents(); // Clear if it already exists from a previous run on the same day
  } else {
    sheet = ss.insertSheet(newSheetName);
  }
  
  sheet.appendRow(["Email Subject"]); // Header
  sheet.getRange(1, 1).setFontWeight("bold"); // Bold the header

  if (subjects.length > 0) {
    sheet.getRange(2, 1, subjects.length, 1).setValues(subjects);
    sheet.setColumnWidth(1, 400); // Set a reasonable width for subjects
    Logger.log(`Subjects written to sheet: ${sheet.getName()}`);
  } else {
    sheet.appendRow(["No subjects found in this label."]);
    Logger.log("No subjects found.");
  }

  ss.setActiveSheet(sheet); // Make the new sheet active
  SpreadsheetApp.getUi().alert('Done', `Successfully extracted ${subjects.length} subjects from "${labelNameToSearch}" and saved to the sheet "${sheet.getName()}".`, SpreadsheetApp.getUi().ButtonSet.OK);
}

function onOpen() {
  var ui = SpreadsheetApp.getUi();
  ui.createMenu('Custom Scripts')
    .addItem('Create Pivot Table and Chart', 'createPivotTableAndChart')
    .addToUi();
}

function createPivotTableAndChart() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getActiveSheet();
  var range = sheet.getDataRange();
  
  // Create a new sheet for the pivot table
  var pivotSheet = ss.insertSheet('PivotTable');
  
  // Create the pivot table
  const pivotTableRange = pivotSheet.getRange('A1');
  const pivotTable = pivotTableRange.createPivotTable(range);

  pivotTable.addRowGroup(3);
  pivotTable.addRowGroup(4);
  pivotTable.addRowGroup(5);

  pivotTable.addPivotValue(3, SpreadsheetApp.PivotTableSummarizeFunction.COUNTA);
  pivotTable.addPivotValue(4, SpreadsheetApp.PivotTableSummarizeFunction.COUNTA);
  pivotTable.addPivotValue(5, SpreadsheetApp.PivotTableSummarizeFunction.COUNTA);
  
  // Wait for the pivot table to be populated
  SpreadsheetApp.flush();
  
  // Create a new sheet for the chart
  var chartSheet = ss.insertSheet('Chart');
  
  // Get the data from the pivot table and prepare it for the chart
  var pivotData = pivotSheet.getDataRange().getValues();
  var chartData = [['Date', 'First Preference', 'Second Preference', 'Third Preference']];
  
  for (var i = 1; i < pivotData.length; i++) {
    var row = pivotData[i];
    var date = row[0];
    var firstPrefCount = row[1] || 0;
    var secondPrefCount = row[2] || 0;
    var thirdPrefCount = row[3] || 0;
    
    chartData.push([date, firstPrefCount, secondPrefCount, thirdPrefCount]);
  }
  
  // Add the chart data to the chart sheet
  chartSheet.getRange(1, 1, chartData.length, chartData[0].length).setValues(chartData);
  
  // Create the stacked column chart
  var chart = chartSheet.newChart()
    .setChartType(Charts.ChartType.COLUMN)
    .addRange(chartSheet.getRange(1, 1, chartData.length, chartData[0].length))
    .setPosition(1, 5, 0, 0)
    .setOption('isStacked', true)
    .setOption('title', 'Preference Dates Distribution')
    .setOption('hAxis', { title: 'Dates' })
    .setOption('vAxis', { title: 'Count' })
    .build();
  
  chartSheet.insertChart(chart);
  
  // Optional: Remove the pivot table sheet
  // ss.deleteSheet(pivotSheet);
}
